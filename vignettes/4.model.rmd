# Part 4: Modeling

## Overview 
### Best Model Posterior Probabilities by Prior
```{r postProbs}
analysis$postProbsPlot
```
`r kfigr::figr(label = "postProbs", prefix = TRUE, link = TRUE, type="Table")`: Best model posterior probabilities by parameter prior; model prior = uniform

### Posterior Parameter Inclusion Probabilities by Prior
`r kfigr::figr(label = "bma_pip", prefix = TRUE, link = TRUE, type="Table")`: Posterior inclusion probabilities across parameter priors; model prior = uniform
```{r bma_pip}
knitr::kable(analysis$pipTable, escape = F, digits = 2) %>%
  kableExtra::kable_styling(bootstrap_options = c("hover", "condensed", "responsive"), full_width = T, position = "center")
```


### Posterior Parameter Inclusion Probabilities by Parameter
```{r bma_pip_top, fig.height=20}
n <- length(analysis$pipPlots)
nCol <- floor(sqrt(n)-1)
do.call("grid.arrange", c(analysis$pipPlots, ncol=nCol))
```
`r kfigr::figr(label = "bma_pip_top", prefix = TRUE, link = TRUE, type="Figure")`: Posterior inclusion probabilities for highest probability parameters

### Model Parameter Inclusion Correlation Across Priors
```{r pip_correlations}
corrplot::corrplot(cor(analysis$pipDf), diag = FALSE,
                     order = "hclust", number.cex = 1,
                     addCoef.col = "black", tl.col = "black",
                     tl.srt = 90, tl.pos = "td", tl.cex = 1,
                     method = "color", type = "upper",
                     col = RColorBrewer::brewer.pal(n = 11,
                                                    name = "PiYG"))
```
`r kfigr::figr(label = "pip_correlations", prefix = TRUE, link = TRUE, type="Figure")`: Correlation of posterior parameter inclusion probabilities across parameter priors; model prior = uniform

### Predictive Performance
`r kfigr::figr(label = "performance", prefix = TRUE, link = TRUE, type="Table")`: Mean MSE on test set for default priors over `r trials` trials.
```{r performance}
knitr::kable(compare$summary, escape = F, digits = 2) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped"), full_width = T, position = "center")
```

### Parameter Density Top 3 Models
**Prior:** `r compare$top[[1]]$priorDesc` **Model:** `r compare$top[[1]]$name` **MSE:** = `r compare$top[[1]]$mse`
`r kfigr::figr(label = "model1_pdc", prefix = TRUE, link = TRUE, type="Table")`: `r compare$top[[1]]$priorDesc` `r compare$top[[1]]$name` parameter distribution
```{r model1_pdc}
pdc <- compare$top[[1]]$pdc$df
pdc <- cbind(Parameter = rownames(compare$top[[1]]$pdc$df), pdc)
pdc <- pdc %>% filter(Probability > 0) %>% select(-Probability)
knitr::kable(pdc, digits = 2) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped"), full_width = T, position = "center")
```

**Prior:** `r compare$top[[2]]$priorDesc` **Model:** `r compare$top[[2]]$name` **MSE:** = `r compare$top[[2]]$mse`
`r kfigr::figr(label = "model2_pdc", prefix = TRUE, link = TRUE, type="Table")`: `r compare$top[[2]]$priorDesc` `r compare$top[[2]]$name` parameter distribution
```{r model2_pdc}
pdc <- compare$top[[2]]$pdc$df
pdc <- cbind(Parameter = rownames(compare$top[[2]]$pdc$df), pdc)
pdc <- pdc %>% filter(Probability > 0) %>% select(-Probability)
knitr::kable(pdc, digits = 2) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped"), full_width = T, position = "center")
```

**Prior:** `r compare$top[[3]]$priorDesc` **Model:** `r compare$top[[3]]$name` **MSE:** = `r compare$top[[3]]$mse`
`r kfigr::figr(label = "model3_pdc", prefix = TRUE, link = TRUE, type="Table")`: `r compare$top[[3]]$priorDesc` `r compare$top[[3]]$name` parameter distribution
```{r model3_pdc}
pdc <- compare$top[[3]]$pdc$df
pdc <- cbind(Parameter = rownames(compare$top[[3]]$pdc$df), pdc)
pdc <- pdc %>% filter(Probability > 0) %>% select(-Probability)
knitr::kable(pdc, digits = 2) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped"), full_width = T, position = "center")
```


### Credible Intervals Top 3 Models
**Prior:** `r compare$top[[1]]$priorDesc` **Model:** `r compare$top[[1]]$name` **MSE:** = `r compare$top[[1]]$mse`
```{r ci1}
plot(compare$top[[1]]$ci)
```
`r kfigr::figr(label = "ci1", prefix = TRUE, link = TRUE, type="Figure")`: `r compare$top[[1]]$priorDesc` `r compare$top[[1]]$name` credible intervals

**Prior:** `r compare$top[[2]]$priorDesc` **Model:** `r compare$top[[2]]$name` **MSE:** = `r compare$top[[2]]$mse`
```{r ci2}
plot(compare$top[[2]]$ci)
```
`r kfigr::figr(label = "ci2", prefix = TRUE, link = TRUE, type="Figure")`: `r compare$top[[2]]$priorDesc` `r compare$top[[2]]$name` credible intervals

**Prior:** `r compare$top[[3]]$priorDesc` **Model:** `r compare$top[[3]]$name` **MSE:** = `r compare$top[[3]]$mse`
```{r ci3}
plot(compare$top[[3]]$ci)
```
`r kfigr::figr(label = "ci3", prefix = TRUE, link = TRUE, type="Figure")`: `r compare$top[[3]]$priorDesc` `r compare$top[[3]]$name` credible intervals

### Residuals vs. Predicted 
**Prior:** `r compare$top[[1]]$priorDesc` **Model:** `r compare$top[[1]]$name` **MSE:** = `r compare$top[[1]]$mse`
```{r ci1}
rvp <- compare$top[[1]]$rvp
plotResFit(rvp, model = paste(compare$top[[1]]$prior, compare$top[[1]]$name))
```
`r kfigr::figr(label = "ci1", prefix = TRUE, link = TRUE, type="Figure")`: `r compare$top[[1]]$priorDesc` `r compare$top[[1]]$name` credible intervals

**Prior:** `r compare$top[[2]]$priorDesc` **Model:** `r compare$top[[2]]$name` **MSE:** = `r compare$top[[2]]$mse`
```{r ci2}
rvp <- compare$top[[2]]$rvp
plotResFit(rvp, model = paste(compare$top[[2]]$prior, compare$top[[2]]$name))
```
`r kfigr::figr(label = "ci2", prefix = TRUE, link = TRUE, type="Figure")`: `r compare$top[[2]]$priorDesc` `r compare$top[[2]]$name` credible intervals

**Prior:** `r compare$top[[3]]$priorDesc` **Model:** `r compare$top[[3]]$name` **MSE:** = `r compare$top[[3]]$mse`
```{r ci3}
rvp <- compare$top[[3]]$rvp
plotResFit(rvp, model = paste(compare$top[[3]]$prior, compare$top[[3]]$name))
```
`r kfigr::figr(label = "ci3", prefix = TRUE, link = TRUE, type="Figure")`: `r compare$top[[3]]$priorDesc` `r compare$top[[3]]$name` credible intervals



#### `r compare$top[[2]]$priorDesc` `r compare$top[[1]]$name`

#### `r compare$top[[3]]$priorDesc` `r compare$top[[1]]$name`
### Model Coefficient CI plots
### Residual vs Fitted
### Interpretation of Coefficients.

* * *
